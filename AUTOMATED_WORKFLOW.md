# ü§ñ Fully Automated Terraform ‚Üí Ansible Workflow

This guide shows the **automated workflow** where Terraform automatically generates all Ansible configuration files with the correct IPs and connection details.

## ‚ú® What Gets Automated?

When you run `terraform apply`, it automatically creates:

1. ‚úÖ **Ansible inventory** (`ansible/inventory/hosts.yml`) with all IPs
2. ‚úÖ **Connection variables** (`ansible/group_vars/terraform_generated.yml`)
3. ‚úÖ **SSH config** (`ansible/ssh_config`) for bastion access

**No manual IP updates needed!** üéâ

## üöÄ Complete Automated Deployment

### Step 1: Configure Terraform (One-Time Setup)

```bash
cd terraform/

# Create your config file
cat > terraform.tfvars << EOF
aws_region = "ap-northeast-2"
key_pair_name = "martin-ap-northeast-2-key"
my_ip = "$(curl -s ifconfig.me)/32"
EOF
```

**Note**: Your `my_ip` is already in terraform.tfvars, so this auto-fills your current IP!

### Step 2: Deploy Infrastructure (Auto-Generates Ansible Config)

```bash
# Initialize Terraform (first time only)
terraform init

# Deploy infrastructure - this auto-generates Ansible files!
terraform apply
```

**What happens automatically:**
- ‚úÖ Creates AWS infrastructure (VPC, EC2 instances, etc.)
- ‚úÖ Generates `ansible/inventory/hosts.yml` with real IPs
- ‚úÖ Generates `ansible/group_vars/terraform_generated.yml` with connection details
- ‚úÖ Generates `ansible/ssh_config` for easy SSH access

### Step 3: Configure SSH (One Command)

```bash
# Add the generated SSH config to your SSH config
cat ../ansible/ssh_config >> ~/.ssh/config

# Or manually copy the contents shown in terraform output
```

### Step 4: Configure Docker Hub Username

```bash
cd ../ansible/

# Edit this ONE file - the only manual step needed
nano group_vars/all.yml
# Change: dockerhub_username: "your-dockerhub-username"
```

### Step 5: Test Connectivity

```bash
# Should return "pong" for all 3 hosts
ansible all -m ping
```

### Step 6: Deploy Everything

```bash
# Install Docker on all instances
ansible-playbook playbooks/install-docker.yml

# Deploy all applications
ansible-playbook playbooks/deploy-all.yml
```

### Step 7: Access Your Apps

```bash
# Get the URLs (auto-shown in terraform output)
cd ../terraform/
terraform output ansible_setup_complete
```

Or directly:
```bash
FRONTEND_IP=$(cd ../terraform && terraform output -raw frontend_public_ip)
echo "Vote:   http://$FRONTEND_IP:80"
echo "Result: http://$FRONTEND_IP:5001"
```

## üîÑ Re-Deploying After Changes

If you make Terraform changes (e.g., change instance types):

```bash
cd terraform/

# Apply changes - Ansible files are auto-regenerated!
terraform apply

# If IPs changed, just re-run Ansible
cd ../ansible/
ansible-playbook playbooks/deploy-all.yml
```

**No manual inventory updates needed!**

## üìÅ Auto-Generated Files

After `terraform apply`, these files are automatically created:

### 1. Ansible Inventory

**Location**: `ansible/inventory/hosts.yml`

```yaml
---
# Auto-generated by Terraform - DO NOT EDIT MANUALLY

all:
  children:
    frontend:
      hosts:
        frontend-instance:
          ansible_host: 3.35.123.45  # Real IP from Terraform!
          ansible_user: ubuntu
          ansible_ssh_private_key_file: ~/.ssh/martin-ap-northeast-2-key.pem
          ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
      vars:
        redis_host: 10.0.2.10  # Real backend IP!
        postgres_host: 10.0.2.20  # Real DB IP!
    # ... backend and database sections
```

### 2. Connection Variables

**Location**: `ansible/group_vars/terraform_generated.yml`

```yaml
---
# Auto-generated by Terraform - DO NOT EDIT MANUALLY

frontend_public_ip: "3.35.123.45"
frontend_private_ip: "10.0.1.10"
backend_private_ip: "10.0.2.10"
database_private_ip: "10.0.2.20"

redis_host: "10.0.2.10"
postgres_host: "10.0.2.20"
redis_port: 6379
postgres_port: 5432
```

### 3. SSH Config

**Location**: `ansible/ssh_config`

```
# Auto-generated SSH config by Terraform

Host frontend-instance
  HostName 3.35.123.45
  User ubuntu
  IdentityFile ~/.ssh/martin-ap-northeast-2-key.pem
  StrictHostKeyChecking no

Host backend-instance
  HostName 10.0.2.10
  User ubuntu
  IdentityFile ~/.ssh/martin-ap-northeast-2-key.pem
  ProxyJump frontend-instance
  StrictHostKeyChecking no

Host db-instance
  HostName 10.0.2.20
  User ubuntu
  IdentityFile ~/.ssh/martin-ap-northeast-2-key.pem
  ProxyJump frontend-instance
  StrictHostKeyChecking no
```

## üéØ Benefits of This Automation

| Manual Process | Automated Process |
|----------------|-------------------|
| ‚ùå Run `terraform apply` | ‚úÖ Run `terraform apply` |
| ‚ùå Copy IPs manually | ‚úÖ **Automatic!** |
| ‚ùå Edit `hosts.yml` | ‚úÖ **Automatic!** |
| ‚ùå Update SSH config | ‚úÖ **Automatic!** |
| ‚ùå Update group_vars | ‚úÖ **Automatic!** |
| ‚ùå Error-prone | ‚úÖ **No errors!** |

**Only manual step**: Update Docker Hub username in `all.yml` (one time)

## üîß How It Works (Technical Details)

### Terraform Resources

```hcl
# terraform/ansible-inventory.tf

# Generate Ansible inventory from template
resource "local_file" "ansible_inventory" {
  content = templatefile("${path.module}/templates/ansible_inventory.tpl", {
    frontend_public_ip  = aws_instance.frontend.public_ip
    backend_private_ip  = aws_instance.backend.private_ip
    db_private_ip       = aws_instance.database.private_ip
    ssh_key_path        = "~/.ssh/${var.key_pair_name}.pem"
  })
  filename = "${path.module}/../ansible/inventory/hosts.yml"
}

# Generate connection variables
resource "local_file" "ansible_connection_vars" {
  content = <<-EOT
  redis_host: "${aws_instance.backend.private_ip}"
  postgres_host: "${aws_instance.database.private_ip}"
  EOT
  filename = "${path.module}/../ansible/group_vars/terraform_generated.yml"
}
```

### Template Files

Templates use Terraform variables to generate files:

- `templates/ansible_inventory.tpl` ‚Üí `ansible/inventory/hosts.yml`
- `templates/ssh_config.tpl` ‚Üí `ansible/ssh_config`

## üß™ Testing the Automation

### Test 1: Verify Files Are Generated

```bash
cd terraform/
terraform apply

# Check that files were created
ls -la ../ansible/inventory/hosts.yml
ls -la ../ansible/group_vars/terraform_generated.yml
ls -la ../ansible/ssh_config
```

### Test 2: Verify IPs Are Correct

```bash
# Check Terraform outputs
terraform output frontend_public_ip

# Check Ansible inventory has same IP
grep ansible_host ../ansible/inventory/hosts.yml
```

They should match!

### Test 3: Test Ansible Connectivity

```bash
cd ../ansible/
ansible all -m ping
```

All hosts should return "pong" ‚úÖ

## üêõ Troubleshooting

### Issue: "hosts.yml" shows placeholder IPs

**Cause**: Terraform wasn't applied, or `local_file` resources weren't created.

**Solution**:
```bash
cd terraform/
terraform apply
# Make sure you see: "local_file.ansible_inventory: Creating..."
```

### Issue: Variables not updating after `terraform apply`

**Cause**: Ansible cached old variables.

**Solution**:
```bash
cd ansible/
# Clear Ansible cache
rm -rf /tmp/ansible_facts

# Re-run playbook
ansible-playbook playbooks/deploy-all.yml
```

### Issue: SSH config not working

**Solution**: Re-append the SSH config
```bash
cat ansible/ssh_config >> ~/.ssh/config

# Or view and manually add
cat ansible/ssh_config
```

## üìä Comparison: Manual vs Automated

### Manual Workflow (Old)
```bash
terraform apply
terraform output  # Copy IPs
nano ansible/inventory/hosts.yml  # Paste IPs
nano ansible/group_vars/frontend.yml  # Update IPs
nano ansible/group_vars/backend.yml  # Update IPs
nano ~/.ssh/config  # Add SSH config
ansible all -m ping  # Test
```
**Time**: ~10 minutes, error-prone ‚ùå

### Automated Workflow (New)
```bash
terraform apply
cat ansible/ssh_config >> ~/.ssh/config
ansible all -m ping
```
**Time**: ~2 minutes, no errors ‚úÖ

## üéâ Summary

With this automation:

1. ‚úÖ **Run once**: `terraform apply`
2. ‚úÖ **Everything generated**: Inventory, variables, SSH config
3. ‚úÖ **No manual editing**: Except Docker Hub username (one-time)
4. ‚úÖ **Always in sync**: Terraform is source of truth
5. ‚úÖ **Idempotent**: Re-run anytime, always correct

## üöÄ Quick Reference

```bash
# Full automated deployment
cd terraform/
terraform apply                              # Auto-generates Ansible files
cat ../ansible/ssh_config >> ~/.ssh/config   # Add SSH config
cd ../ansible/
nano group_vars/all.yml                      # Update dockerhub_username (one-time)
ansible all -m ping                          # Test
ansible-playbook playbooks/install-docker.yml
ansible-playbook playbooks/deploy-all.yml

# Access apps
FRONTEND_IP=$(cd ../terraform && terraform output -raw frontend_public_ip)
echo "Vote:   http://$FRONTEND_IP:80"
echo "Result: http://$FRONTEND_IP:5001"
```

**That's it!** No manual IP copying, no typos, no hassle! üéä
