---
- name: Install and Configure AWS CloudWatch Agent
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Download CloudWatch Agent
      ansible.builtin.get_url:
        url: https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
        dest: /tmp/amazon-cloudwatch-agent.deb
        mode: '0644'

    - name: Install CloudWatch Agent
      ansible.builtin.apt:
        deb: /tmp/amazon-cloudwatch-agent.deb
        state: present

    - name: Create CloudWatch config directory
      ansible.builtin.file:
        path: /opt/aws/amazon-cloudwatch-agent/etc
        state: directory
        mode: '0755'

    - name: Copy CloudWatch configuration
      ansible.builtin.copy:
        src: ../../monitoring/cloudwatch/cloudwatch-config.json
        dest: /opt/aws/amazon-cloudwatch-agent/etc/config.json
        mode: '0644'

    - name: Start CloudWatch Agent
      ansible.builtin.shell: |
        /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
          -a fetch-config \
          -m ec2 \
          -s \
          -c file:/opt/aws/amazon-cloudwatch-agent/etc/config.json
      register: agent_start
      changed_when: agent_start.rc == 0

    - name: Check CloudWatch Agent status
      ansible.builtin.shell: |
        /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
          -a status \
          -m ec2
      register: agent_status
      changed_when: false

    - name: Display CloudWatch Agent status
      ansible.builtin.debug:
        msg: "{{ agent_status.stdout }}"

- name: Configure Application-Specific Monitoring
  hosts: frontend
  become: yes

  tasks:
    - name: Install CloudWatch container insights (Docker metrics)
      ansible.builtin.shell: |
        docker run -d \
          --name cloudwatch-agent \
          --restart always \
          --network host \
          -v /var/run/docker.sock:/var/run/docker.sock:ro \
          -v /sys:/sys:ro \
          -v /proc:/proc:ro \
          -e AWS_REGION=ap-northeast-2 \
          amazon/cloudwatch-agent:latest
      register: docker_metrics
      failed_when: false
      changed_when: docker_metrics.rc == 0

- name: Display Setup Complete Message
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Show CloudWatch setup information
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… CloudWatch Agent Setup Complete!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“Š Metrics are being sent to CloudWatch:
             Namespace: VotingApp/Infrastructure
             Region: ap-northeast-2

          ğŸ“ Logs are being collected:
             - /var/log/syslog â†’ /voting-app/system
             - /var/log/docker.log â†’ /voting-app/docker

          ğŸ”— View in AWS Console:
             https://console.aws.amazon.com/cloudwatch/

          Next Steps:
          1. Go to CloudWatch Console
          2. Click "Metrics" â†’ "VotingApp/Infrastructure"
          3. View custom dashboards
          4. Set up alarms
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
