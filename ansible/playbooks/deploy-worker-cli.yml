---
- name: Deploy Worker App (Using Docker CLI)
  hosts: backend
  become: no  # Run as ubuntu user who has docker group membership
  gather_facts: yes
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Pull Worker image
      ansible.builtin.command:
        cmd: "docker pull {{ worker_image }}:{{ worker_image_tag }}"
      register: pull_result
      changed_when: "'Downloaded' in pull_result.stdout or 'Pulling' in pull_result.stdout"

    - name: Stop existing Worker container if running
      ansible.builtin.command:
        cmd: docker stop worker
      register: stop_result
      failed_when: false
      changed_when: stop_result.rc == 0

    - name: Remove existing Worker container if exists
      ansible.builtin.command:
        cmd: docker rm worker
      register: rm_result
      failed_when: false
      changed_when: rm_result.rc == 0

    - name: Deploy Worker container
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name worker
          --restart always
          -e REDIS_HOST={{ redis_host }}
          -e REDIS_PORT={{ redis_port }}
          -e POSTGRES_HOST={{ postgres_host }}
          -e POSTGRES_PORT={{ postgres_port }}
          -e POSTGRES_USER={{ postgres_user }}
          -e POSTGRES_PASSWORD={{ postgres_password }}
          -e POSTGRES_DB={{ postgres_db }}
          {{ worker_image }}:{{ worker_image_tag }}
      register: deploy_result
      changed_when: deploy_result.rc == 0

    - name: Wait for Worker to start
      ansible.builtin.pause:
        seconds: 10

    - name: Verify Worker is running
      ansible.builtin.command:
        cmd: docker ps --filter name=worker --format "{%raw%}{{.Status}}{%endraw%}"
      register: ps_result
      changed_when: false

    - name: Display Worker status
      ansible.builtin.debug:
        msg: "Worker is running on {{ ansible_host }} - Status: {{ ps_result.stdout }}"

    - name: Check Worker logs
      ansible.builtin.command:
        cmd: docker logs --tail 20 worker
      register: logs_result
      changed_when: false

    - name: Display Worker logs
      ansible.builtin.debug:
        msg: "{{ logs_result.stdout_lines }}"
