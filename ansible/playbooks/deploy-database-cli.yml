---
- name: Deploy PostgreSQL Database (Using Docker CLI)
  hosts: database
  become: no  # Run as ubuntu user who has docker group membership
  gather_facts: yes
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Create Docker volume for PostgreSQL data
      ansible.builtin.command:
        cmd: docker volume create postgres-data
      register: volume_result
      failed_when: volume_result.rc != 0 and 'already exists' not in volume_result.stderr
      changed_when: "'postgres-data' in volume_result.stdout"

    - name: Pull PostgreSQL image
      ansible.builtin.command:
        cmd: "docker pull postgres:{{ postgres_image_tag }}"
      register: pull_result
      changed_when: "'Downloaded' in pull_result.stdout or 'Pulling' in pull_result.stdout"

    - name: Stop existing PostgreSQL container if running
      ansible.builtin.command:
        cmd: docker stop postgres
      register: stop_result
      failed_when: false
      changed_when: stop_result.rc == 0

    - name: Remove existing PostgreSQL container if exists
      ansible.builtin.command:
        cmd: docker rm postgres
      register: rm_result
      failed_when: false
      changed_when: rm_result.rc == 0

    - name: Deploy PostgreSQL container
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name postgres
          --restart always
          -p 5432:5432
          -e POSTGRES_USER={{ postgres_user }}
          -e POSTGRES_PASSWORD={{ postgres_password }}
          -e POSTGRES_DB={{ postgres_db }}
          -v postgres-data:/var/lib/postgresql/data
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          postgres:{{ postgres_image_tag }}
      register: deploy_result
      changed_when: deploy_result.rc == 0

    - name: Wait for PostgreSQL to be ready
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 5432
        delay: 5
        timeout: 60
        state: started

    - name: Verify PostgreSQL is running
      ansible.builtin.command:
        cmd: docker ps --filter name=postgres --format "{%raw%}{{.Status}}{%endraw%}"
      register: ps_result
      changed_when: false

    - name: Display PostgreSQL status
      ansible.builtin.debug:
        msg: "PostgreSQL is running on {{ ansible_host }}:5432 - Status: {{ ps_result.stdout }}"
