---
- name: Deploy Frontend Services (Vote + Result)
  hosts: frontend
  become: yes
  gather_facts: no

  tasks:
    - name: Pull Vote image
      community.docker.docker_image:
        name: "{{ dockerhub_username }}/vote:{{ vote_image_tag }}"
        source: pull
        state: present

    - name: Deploy Vote container
      community.docker.docker_container:
        name: vote
        image: "{{ dockerhub_username }}/vote:{{ vote_image_tag }}"
        state: started
        restart_policy: always
        ports:
          - "80:80"
        env:
          REDIS_HOST: "{{ redis_host }}"
          REDIS_PORT: "{{ redis_port }}"

    - name: Wait for Vote app to be ready
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 80
        delay: 3
        timeout: 30
        state: started

    - name: Display Vote status
      ansible.builtin.debug:
        msg: "Vote app is running on http://{{ ansible_host }}:80"

    - name: Pull Result image
      community.docker.docker_image:
        name: "{{ dockerhub_username }}/result:{{ result_image_tag }}"
        source: pull
        state: present

    - name: Deploy Result container
      community.docker.docker_container:
        name: result
        image: "{{ dockerhub_username }}/result:{{ result_image_tag }}"
        state: started
        restart_policy: always
        ports:
          - "5001:80"
        env:
          POSTGRES_HOST: "{{ postgres_host }}"
          POSTGRES_PORT: "{{ postgres_port }}"
          POSTGRES_USER: "{{ postgres_user }}"
          POSTGRES_PASSWORD: "{{ postgres_password }}"
          POSTGRES_DB: "{{ postgres_db }}"

    - name: Wait for Result app to be ready
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 5001
        delay: 3
        timeout: 30
        state: started

    - name: Display Result status
      ansible.builtin.debug:
        msg: "Result app is running on http://{{ ansible_host }}:5001"

    - name: Show Vote logs (last 10 lines)
      ansible.builtin.command: docker logs --tail 10 vote
      register: vote_logs
      changed_when: false

    - name: Display Vote logs
      ansible.builtin.debug:
        var: vote_logs.stdout_lines

    - name: Show Result logs (last 10 lines)
      ansible.builtin.command: docker logs --tail 10 result
      register: result_logs
      changed_when: false

    - name: Display Result logs
      ansible.builtin.debug:
        var: result_logs.stdout_lines
