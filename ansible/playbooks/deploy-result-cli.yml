---
- name: Deploy Result App (Using Docker CLI)
  hosts: frontend
  become: no  # Run as ubuntu user who has docker group membership
  gather_facts: yes
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Pull Result image
      ansible.builtin.command:
        cmd: "docker pull {{ result_image }}:{{ result_image_tag }}"
      register: pull_result
      changed_when: "'Downloaded' in pull_result.stdout or 'Pulling' in pull_result.stdout"

    - name: Stop existing Result container if running
      ansible.builtin.command:
        cmd: docker stop result
      register: stop_result
      failed_when: false
      changed_when: stop_result.rc == 0

    - name: Remove existing Result container if exists
      ansible.builtin.command:
        cmd: docker rm result
      register: rm_result
      failed_when: false
      changed_when: rm_result.rc == 0

    - name: Deploy Result container
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name result
          --restart always
          -p {{ result_port }}:80
          --add-host db:{{ postgres_host }}
          -e POSTGRES_HOST=db
          -e POSTGRES_PORT={{ postgres_port }}
          -e POSTGRES_USER={{ postgres_user }}
          -e POSTGRES_PASSWORD={{ postgres_password }}
          -e POSTGRES_DB={{ postgres_db }}
          {{ result_image }}:{{ result_image_tag }}
      register: deploy_result
      changed_when: deploy_result.rc == 0

    - name: Wait for Result app to be ready
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: "{{ result_port }}"
        delay: 5
        timeout: 60
        state: started

    - name: Verify Result is running
      ansible.builtin.command:
        cmd: docker ps --filter name=result --format "{%raw%}{{.Status}}{%endraw%}"
      register: ps_result
      changed_when: false

    - name: Display Result status
      ansible.builtin.debug:
        msg: "Result app is running on http://{{ ansible_host }}:{{ result_port }} - Status: {{ ps_result.stdout }}"

    - name: Check Result logs
      ansible.builtin.command:
        cmd: docker logs --tail 20 result
      register: logs_result
      changed_when: false

    - name: Display Result logs
      ansible.builtin.debug:
        msg: "{{ logs_result.stdout_lines }}"
