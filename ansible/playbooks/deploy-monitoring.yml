---
- name: Deploy Monitoring Stack (Prometheus + Grafana + Node Exporters)
  hosts: all
  become: no
  gather_facts: yes

  tasks:
    - name: Deploy Node Exporter on all instances
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name node-exporter
          --restart always
          --net="host"
          --pid="host"
          -v "/:/host:ro,rslave"
          prom/node-exporter:latest
          --path.rootfs=/host
      register: deploy_result
      failed_when: false
      changed_when: deploy_result.rc == 0

    - name: Check Node Exporter status
      ansible.builtin.command:
        cmd: docker ps --filter name=node-exporter --format "{%raw%}{{.Status}}{%endraw%}"
      register: exporter_status
      changed_when: false

    - name: Display Node Exporter status
      ansible.builtin.debug:
        msg: "Node Exporter on {{ inventory_hostname }}: {{ exporter_status.stdout }}"

- name: Deploy Prometheus and Grafana on Frontend
  hosts: frontend
  become: no
  gather_facts: yes

  tasks:
    - name: Create monitoring directory
      ansible.builtin.file:
        path: ~/monitoring
        state: directory
        mode: '0755'

    - name: Copy Prometheus config
      ansible.builtin.copy:
        src: ../../monitoring/prometheus/prometheus.yml
        dest: ~/monitoring/prometheus.yml
        mode: '0644'

    - name: Stop existing Prometheus if running
      ansible.builtin.command:
        cmd: docker stop prometheus
      register: stop_result
      failed_when: false
      changed_when: stop_result.rc == 0

    - name: Remove existing Prometheus container
      ansible.builtin.command:
        cmd: docker rm prometheus
      register: rm_result
      failed_when: false
      changed_when: rm_result.rc == 0

    - name: Deploy Prometheus
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name prometheus
          --restart always
          --net="host"
          -v ~/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
          -v prometheus-data:/prometheus
          prom/prometheus:latest
          --config.file=/etc/prometheus/prometheus.yml
          --storage.tsdb.path=/prometheus
          --web.enable-lifecycle
      register: deploy_prom
      changed_when: deploy_prom.rc == 0

    - name: Wait for Prometheus to start
      ansible.builtin.wait_for:
        port: 9090
        delay: 5
        timeout: 30

    - name: Stop existing Grafana if running
      ansible.builtin.command:
        cmd: docker stop grafana
      register: stop_grafana
      failed_when: false
      changed_when: stop_grafana.rc == 0

    - name: Remove existing Grafana container
      ansible.builtin.command:
        cmd: docker rm grafana
      register: rm_grafana
      failed_when: false
      changed_when: rm_grafana.rc == 0

    - name: Deploy Grafana
      ansible.builtin.command:
        cmd: >
          docker run -d
          --name grafana
          --restart always
          --net="host"
          -e GF_SECURITY_ADMIN_USER=admin
          -e GF_SECURITY_ADMIN_PASSWORD=admin
          -v grafana-data:/var/lib/grafana
          grafana/grafana:latest
      register: deploy_grafana
      changed_when: deploy_grafana.rc == 0

    - name: Wait for Grafana to start
      ansible.builtin.wait_for:
        port: 3000
        delay: 5
        timeout: 60

    - name: Display access information
      ansible.builtin.debug:
        msg: |
          ====================================
          ðŸŽ‰ Monitoring Stack Deployed!
          ====================================

          Prometheus: http://{{ ansible_host }}:9090
          - View metrics and targets
          - Query PromQL

          Grafana: http://{{ ansible_host }}:3000
          - Username: admin
          - Password: admin

          Node Exporters running on:
          - Frontend: {{ ansible_host }}:9100
          - Backend: 10.0.2.75:9100
          - Database: 10.0.2.115:9100

          Next steps:
          1. Open Grafana in browser
          2. Add Prometheus datasource (http://localhost:9090)
          3. Import dashboard or create your own!
          ====================================
