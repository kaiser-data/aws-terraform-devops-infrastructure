---
- name: Complete Voting App Deployment
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Deployment start message
      ansible.builtin.debug:
        msg: "Starting complete deployment of Voting App infrastructure..."

# Step 1: Deploy Database (PostgreSQL must be running before Worker)
- name: Deploy Database Tier
  ansible.builtin.import_playbook: deploy-database.yml

# Step 2: Deploy Backend (Redis + Worker)
- name: Deploy Backend Tier
  ansible.builtin.import_playbook: deploy-backend.yml

# Step 3: Deploy Frontend (Vote + Result)
- name: Deploy Frontend Tier
  ansible.builtin.import_playbook: deploy-frontend.yml

# Final summary
- name: Deployment Summary
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Voting App Deployment Complete!"
          - "=========================================="
          - ""
          - "Access your applications:"
          - "  Vote App:   http://{{ hostvars['frontend-instance']['ansible_host'] }}:80"
          - "  Result App: http://{{ hostvars['frontend-instance']['ansible_host'] }}:5001"
          - ""
          - "Backend Services:"
          - "  Redis:      {{ hostvars['backend-instance']['ansible_host'] }}:6379"
          - "  Worker:     Running on backend instance"
          - "  PostgreSQL: {{ hostvars['db-instance']['ansible_host'] }}:5432"
          - ""
          - "Next steps:"
          - "1. Test the Vote app - cast a vote"
          - "2. Check the Result app - see vote counts"
          - "3. Verify logs: ansible-playbook playbooks/check-logs.yml"
          - "=========================================="
