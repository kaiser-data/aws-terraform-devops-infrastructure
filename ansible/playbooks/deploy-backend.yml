---
- name: Deploy Backend Services (Redis + Worker)
  hosts: backend
  become: yes
  gather_facts: no

  tasks:
    - name: Create Docker volume for Redis data
      community.docker.docker_volume:
        name: redis-data
        state: present

    - name: Pull Redis image
      community.docker.docker_image:
        name: "redis:{{ redis_image_tag }}"
        source: pull
        state: present

    - name: Deploy Redis container
      community.docker.docker_container:
        name: redis
        image: "redis:{{ redis_image_tag }}"
        state: started
        restart_policy: always
        ports:
          - "6379:6379"
        command: ["redis-server", "--appendonly", "yes"]
        volumes:
          - redis-data:/data

    - name: Wait for Redis to be ready
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 6379
        delay: 3
        timeout: 30
        state: started

    - name: Display Redis status
      ansible.builtin.debug:
        msg: "Redis is running on {{ ansible_host }}:6379"

    - name: Pull Worker image
      community.docker.docker_image:
        name: "{{ dockerhub_username }}/worker:{{ worker_image_tag }}"
        source: pull
        state: present

    - name: Deploy Worker container
      community.docker.docker_container:
        name: worker
        image: "{{ dockerhub_username }}/worker:{{ worker_image_tag }}"
        state: started
        restart_policy: always
        env:
          REDIS_HOST: "{{ redis_host }}"
          REDIS_PORT: "{{ redis_port }}"
          POSTGRES_HOST: "{{ postgres_host }}"
          POSTGRES_PORT: "{{ postgres_port }}"
          POSTGRES_USER: "{{ postgres_user }}"
          POSTGRES_PASSWORD: "{{ postgres_password }}"
          POSTGRES_DB: "{{ postgres_db }}"

    - name: Display Worker status
      ansible.builtin.debug:
        msg: "Worker is running and connecting to Redis ({{ redis_host }}:{{ redis_port }}) and PostgreSQL ({{ postgres_host }}:{{ postgres_port }})"

    - name: Show Worker logs (last 20 lines)
      ansible.builtin.command: docker logs --tail 20 worker
      register: worker_logs
      changed_when: false

    - name: Display Worker logs
      ansible.builtin.debug:
        var: worker_logs.stdout_lines
